services:
  db:
    image: "docker.io/library/postgres:${POSTGRESQL_VERSION:-16}"
    container_name: inmanta-db
    pull_policy: always
    environment:
      POSTGRES_USER: inmanta
      POSTGRES_PASSWORD: inmanta
      POSTGRES_HOST_AUTH_METHOD: |
        scram-sha-256
        host replication all 0.0.0.0/0 md5
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    command: |
      postgres
      -c wal_level=replica
      -c synchronous_commit=on
      -c hot_standby=off
      -c jit=off
    volumes:
      - inmanta-db-data:/var/lib/postgresql/data
      - ./00_init.sql:/docker-entrypoint-initdb.d/00_init.sql
  db-replica:
    image: "docker.io/library/postgres:${POSTGRESQL_VERSION:-16}"
    container_name: inmanta-db-replica
    pull_policy: always
    user: postgres
    restart: always
    environment:
      PGHOST: db
      PGUSER: replicator
      PGPASSWORD: replicator_password
      PGAPPNAME: inmanta
    # Inspired from https://medium.com/@eremeykin/how-to-setup-single-primary-postgresql-replication-with-docker-compose-98c48f233bbf
    command: |
      bash -c "
      until pg_basebackup --pgdata=/var/lib/postgresql/data -R --slot=replication_slot
      do
      echo 'Waiting for primary to connect...'
      sleep 1s
      done
      echo 'Backup done, starting replica...'
      exec postgres
      "
    volumes:
      - inmanta-db-replica-data:/var/lib/postgresql/data

volumes:
  inmanta-db-replica-data: {}
